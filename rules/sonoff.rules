// Work with a list of selected Sonoff modules
val sonoff_device_ids = newArrayList(
//    "sonoff06",
    "sonoff06"
)

// OR
// Work with the grouptopic, addressing ALL modules at once
//val sonoff_device_ids = newArrayList("sonoffs")

rule "Sonoff Maintenance"
when
  Item Sonoff_Action received command
then 
  logInfo("sonoff.rules", "Sonoff Maintenance on all devices: " + receivedCommand)
  for (String device_id : sonoff_device_ids) {
    switch (receivedCommand) {
      case "restart" :
        publish("broker", "cmnd/" + device_id + "/restart", "1") 
      case "queryFW" :
        publish("broker", "cmnd/" + device_id + "/status", "2")
      case "upgrade" : {
        publish("broker", "cmnd/" + device_id + "/otaurl", "http://thehackbox.org/tasmota/release/020300/sonoff-minimal.bin")
        publish("broker", "cmnd/" + device_id + "/upgrade", "1")
        logInfo("sonoff.rules", "Sonoff Maintenance on " + device_id + ": upgrading to sonoff-minimal.bin")
        createTimer(now.plusSeconds(120), [|
          publish("broker", "cmnd/" + device_id + "/otaurl", "http://thehackbox.org/tasmota/release/020300/sonoff.bin")
          publish("broker", "cmnd/" + device_id + "/upgrade", "1")
          logInfo("sonoff.rules", "Sonoff Maintenance " + device_id + ": upgrading to sonoff.bin" )
        ])

      }
    }
  }
  Sonoff_Action.postUpdate(NULL)
end
