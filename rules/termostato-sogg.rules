rule "Termostato Acceso"
  when
    Item spSoggiorno changed or
    Item Casa_Temperature_AVG changed or
    Item hsSoggiorno changed or
    Item tsSoggiorno changed to ON
  then
  
  var Number cur_temp = Casa_Temperature_AVG.state
  var Number sp = spSoggiorno.state
  var Number setpoint = sp.floatValue
  var Number hs = hsSoggiorno.state
  var Number hysteresis = hs.floatValue
  //var Number tDiff = (setpoint - cur_temp).floatValue
  var Number tDiffD = (cur_temp - setpoint).floatValue
  var Number tDiffU = (cur_temp - setpoint + hysteresis).floatValue
  var Number sa = Air_Conditioner_Temperature.state as DecimalType
  var Number cdzTemp = 0

  if (tsSoggiorno.state == ON) {
    logInfo("tsSoggiorno","DEBUG tsSogg:" + cur_temp + "C, U:" + tDiffU + ", D:" + tDiffD +" - (" + setpoint + " +" + hysteresis + "C) A/C: " + sa + "C")

    // CHECK IF TEMPERATURE IS OK
    if (sa >= 30.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa5: " + sa)
      if (tDiffD > -1.5 )    cdzTemp = 23.0
    }
    if (sa >= 23.0 && sa < 30.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa4: " + sa)
      if (tDiffU <  -1.5 )   cdzTemp = 31.0
      if (tDiffD >= -0.5 )   cdzTemp = 20.0
    }
    if (sa >= 20.0 && sa < 23.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa3: " + sa)
      if (tDiffU < -0.5 )   cdzTemp = 23.0
      if (tDiffD >= 0.0 )   cdzTemp = 19.0
    }
    if (sa == 19.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa2: " + sa)
      if (tDiffU <  0.0 )   cdzTemp = 20.0
      if (tDiffD >= 0.5 )   cdzTemp = 18.0
    }
    if (sa == 18.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa1: " + sa)
      if (tDiffU <  0.5 )   cdzTemp = 19.0
      if (tDiffD >= 1.0 )   cdzTemp = 10.0
    }
    if (sa == 10.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa0: " + sa)
      if ( tDiffD <= -1.5 )                   cdzTemp = 31.0
      if ( tDiffD > -1.5 && tDiffD <= -0.5 )  cdzTemp = 23.0
      if ( tDiffD > -0.5 && tDiffD <= 0.0 )   cdzTemp = 20.0
      if ( tDiffD >  0.0 && tDiffD <  0.5 )   cdzTemp = 19.0
      if ( tDiffD >  0.5 && tDiffU <  1.0 )   cdzTemp = 18.0
    }

    // ACTION if cdzTemp changed
    if (cdzTemp != 0 ) {
      logInfo("tsSoggiorno","DEBUG tsSogg: imposto: " + cdzTemp )
      Air_Conditioner_Temperature.sendCommand(cdzTemp)
    } else {
      logInfo("tsSoggiorno","DEBUG tsSogg: ok")
   }

  }
end

rule "Termostato Spento"
  when
    Item tsSoggiorno changed to OFF
  then
    Air_Conditioner_Temperature.sendCommand(10.0)
end
