rule "Termostato Soggiorno"
  when
    Item spSoggiorno changed or
    Item Casa_Temperature_AVG changed or
    Item hsSoggiorno changed or
    Item tsSoggiorno changed to ON
  then
  
  var Number cur_temp = Casa_Temperature_AVG.state
  var Number sp = spSoggiorno.state
  var Number setpoint = sp.floatValue
  var Number hs = hsSoggiorno.state
  var Number hysteresis = hs.floatValue
  //var Number tDiff = (setpoint - cur_temp).floatValue
  var Number tDiffD = (cur_temp - setpoint).floatValue
  var Number tDiffU = (cur_temp - setpoint - hysteresis).floatValue
  var Number sa = Air_Conditioner_Temperature.state as DecimalType
  var Number cdzTemp = 0

  if (tsSoggiorno.state == ON) {
    logInfo("tsSoggiorno","DEBUG tsSogg: " + cur_temp + "C, sPt: " + setpoint + ", hst: " + hysteresis + "C, tDiffD: " + tDiffD + "C, tDiffU: " + tDiffU + "C, A/C: " + sa + "C")

    // CHECK IF TEMPERATURE IS OK
    if (sa == 35.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa5: " + sa)
      if (tDiffU < 1.5 )    cdzTemp = 23.0
    }
    if (sa >= 23.0 && sa < 35.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa4: " + sa)
      if (tDiffD  > 1.5 )   cdzTemp = 35.0
      if (tDiffU <= 0.5 )   cdzTemp = 20.0
    }
    if (sa >= 20.0 && sa < 23.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa3: " + sa)
      if (tDiffD  > 0.5 )   cdzTemp = 23.0
      if (tDiffU <= -0.5 )  cdzTemp = 19.0
    }
    if (sa == 19.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa2: " + sa)
      if (tDiffD >  -0.5 )  cdzTemp = 20.0
      if (tDiffU <= -1.5 )  cdzTemp = 18.0
    }
    if (sa == 18.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa1: " + sa)
      if (tDiffD >  -1.5 )  cdzTemp = 19.0
      if (tDiffU <= -2.0 )  cdzTemp = 10.0
    }
    if (sa == 10.0) {
      logInfo("tsSoggiorno","DEBUG tsSogg: stato sa0: " + sa)
      if ( tDiffD > -2.0 ) cdzTemp = 18.0
    }

    // ACTION if cdzTemp changed
    if (cdzTemp != 0 ) {
      logInfo("tsSoggiorno","DEBUG tsSogg: imposto: " + cdzTemp )
    } else {
      logInfo("tsSoggiorno","DEBUG tsSogg: ok")
   }

  }
end
