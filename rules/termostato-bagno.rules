rule "Termostato Bagno"
  when
    Item spBagno changed or
    Item sf07_Temp changed or
    Item tsBagno received command
  then
  
  var Number cur_temp = sf07_Temp.state 
  var Number setpoint = spBagno.state 
  var Number hysteresis = hsBagno.state 
  var Number hsetpoint = setpoint.floatValue - hysteresis.floatValue

  logInfo("tsBagno","DEBUG Stufetta: Valuto la regola")
  if (tsBagno.state == ON) {
    logInfo("tsBagno","DEBUG Stufetta: tsBagno.state == ON")
    logInfo("tsBagno","DEBUG Stufetta: cur_temp: " + (cur_temp).floatValue + ", setpoint: " + ((setpoint).floatValue + ", hysteresis: " + (hysteresis).floatValue) + "C")
    if (sf07_Light.state == ON) {
      logInfo("tsBagno","DEBUG Stufetta: trovata ON, verifico di non superare i " + (setpoint).floatValue + "C")
      if ((cur_temp).floatValue > ((setpoint).floatValue)) {
        logInfo("tsBagno","DEBUG Stufetta: Ho superato, ci sono " + (cur_temp).floatValue + "C")
        sendCommand(sf07_Light, OFF)
        logInfo("tsBagno","DEBUG Stufetta: SPENGO la stufetta")
      }
    }
    else {
      logInfo("tsBagno","DEBUG Stufetta: trovata OFF, verifico che non ci siano meno di  " + (hsetpoint).floatValue + "C")
      if ((cur_temp).floatValue < ((setpoint).floatValue - (hysteresis).floatValue)) {
        logInfo("tsBagno","DEBUG Stufetta: ci sono " + (cur_temp).floatValue + "C")
        sendCommand(sf07_Light, ON)
        logInfo("tsBagno","DEBUG Stufetta: ACCENDO la stufetta")
      }
    }
  }
end
